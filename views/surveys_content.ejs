<div class="survey-page container my-5">

    <!-- Event Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1><%= event.EventName %></h1>
        <% if (user.role === "admin") { %>
            <a href="/add_survey/<%= user.id %>/<%= event.Event_ID %>/<%= encodeURIComponent(new Date(event.EventDateTimeStart).toISOString()) %>" class="btn btn-success">
                Add Survey
            </a>
        <% } %>
    </div>

    <p class="event-date mb-4">
        <strong>Date:</strong>
        <%= new Date(event.EventDateTimeStart).toLocaleString() %>
    </p>

    <!-- Overall Score -->
    <div class="mb-4">
        <h2>Overall Score: <%= averages.overall %></h2>
        <table class="table table-bordered table-sm w-50">
            <thead class="table-light">
                <tr>
                    <th>Satisfaction</th>
                    <th>Usefulness</th>
                    <th>Instructor</th>
                    <th>Recommendation</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><%= averages.satisfaction %></td>
                    <td><%= averages.usefulness %></td>
                    <td><%= averages.instructor %></td>
                    <td><%= averages.recommendation %></td>
                </tr>
            </tbody>
        </table>
    </div>

    <hr>

    <h2 class="mb-3">Survey Submissions</h2>

    <div class="survey-cards-container d-flex flex-wrap gap-3 justify-content-start">

        <% surveys.forEach(s => { %>
            <div class="survey-card d-flex flex-column justify-content-between" 
                 data-satisfaction="<%= s.SurveySatisfaction %>" 
                 data-usefulness="<%= s.SurveyUsefulnessScore %>" 
                 data-instructor="<%= s.SurveyInstructorScore %>" 
                 data-recommendation="<%= s.SurveyRecommendationScore %>" 
                 data-comments="<%= s.SurveyComments || 'No comments' %>"
                 data-date="<%= new Date(s.SurveySubmissionDate).toLocaleString() %>">

                <div>
                    <h5><%= s.ParticipantFirstName %> <%= s.ParticipantLastName %></h5>
                    <p><strong>Overall Score:</strong> <%= s.SurveyOverallScore %></p>
                    <p><strong>NPS Bucket:</strong> <%= s.SurveyNPSBucket %></p>
                </div>

                <div class="mt-3 d-flex flex-column align-items-center gap-2">
                    <form action="/survey/<%= s.Participant_ID %>/<%= s.Event_ID %>/<%= encodeURIComponent(new Date(s.EventDateTimeStart).toISOString()) %>/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this survey?');" class="w-100 d-flex justify-content-center">
                        <button type="submit" class="btn btn-danger w-90">Delete</button>
                    </form>
                    <a href="/survey/<%= s.Participant_ID %>/<%= s.Event_ID %>/<%= encodeURIComponent(new Date(s.EventDateTimeStart).toISOString()) %>/edit" class="btn btn-warning w-90 text-center">
                        Edit
                    </a>
                </div>

            </div>
        <% }) %>

    </div>
</div>

<!-- Styles -->
<style>
    .survey-card {
        background: #ffffff;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.18);
        width: 260px;
        transition: transform 0.15s ease-in-out;
        display: flex;
        flex-direction: column;
        position: relative; /* Needed for tooltip positioning */
    }

    .survey-card:hover {
        transform: translateY(-3px);
    }

    .w-90 {
        width: 90%;
    }

    .survey-cards-container {
        margin-top: 20px;
    }

    /* Tooltip box hidden by default */
    .tooltip-box {
        display: none;
        position: absolute;
        top: 105%;
        left: 50%;
        transform: translateX(-50%);
        background: #f9f9f9;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        width: 260px;
        z-index: 10;
        font-size: 0.9rem;
    }

    /* Show tooltip on hover */
    .survey-card:hover .tooltip-box {
        display: block;
    }
</style>

<!-- Tooltip Script -->
<script>
    document.querySelectorAll('.survey-card').forEach(card => {
        const tooltip = document.createElement('div');
        tooltip.classList.add('tooltip-box');

        tooltip.innerHTML = `
            <strong>Satisfaction:</strong> ${card.dataset.satisfaction}<br>
            <strong>Usefulness:</strong> ${card.dataset.usefulness}<br>
            <strong>Instructor:</strong> ${card.dataset.instructor}<br>
            <strong>Recommendation:</strong> ${card.dataset.recommendation}<br>
            <strong>Comments:</strong> ${card.dataset.comments}<br>
            <strong>Submitted:</strong> ${card.dataset.date}
        `;

        card.appendChild(tooltip);
    });
</script>
